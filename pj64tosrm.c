/* pj64tosrm
 * Combine Project64's save files (*.eep, *.mpk, *.fla, *.sra) into a
 * libretro-mupen64 save file (*.srm).
 * 
 * KNOWN BUGS:
 *     - Some NRage Input Plugin saves may not work regardless of the type.
 */

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

/* from libretro's mupen64+ source (save_memory_data) */
static struct
{
	uint8_t eeprom[0x200];
	uint8_t mempack[4][0x8000];
	uint8_t sram[0x8000];
	uint8_t flashram[0x20000];
	uint8_t eeprom2[0x600];
} srm;

static void die(const char *msg)
{
	puts(msg);
	exit(-1);
}

static void read_mem(const char *filename, void *dest, size_t size)
{
	FILE *fp = fopen(filename, "rb");

	if (!fp) {
		perror(filename);
		exit(EXIT_FAILURE);
	}

	fread(dest, size, 1, fp);

	if (dest == srm.eeprom)
		fread(srm.eeprom2, sizeof(srm.eeprom2), 1, fp);

	if (ferror(fp)) {
		perror(filename);
		fclose(fp);
		exit(EXIT_FAILURE);
	}

	fclose(fp);
}

static void write_mem(const char *filename, void *source, size_t size)
{
	FILE *fp = fopen(filename, "wb");

	if (!fp) {
		perror(filename);
		exit(EXIT_FAILURE);
	}

	fwrite(source, size, 1, fp);

	if (source == srm.eeprom) {
		int i;
		for (i = sizeof(srm.eeprom2)-1; i >= 0; --i) {
			if (srm.eeprom2[i] != 0) {
				fwrite(srm.eeprom2, i+1, 1, fp);
				break;
			}
		}
	}

	if (ferror(fp)) {
		perror(filename);
		fclose(fp);
		exit(EXIT_FAILURE);
	}

	fclose(fp);
}

/* from libretro mupen64+ format_saved_memory()*/
static void format_srm(void)
{
   uint8_t init[] = {
      0x81,0x01,0x02,0x03, 0x04,0x05,0x06,0x07, 0x08,0x09,0x0a,0x0b, 0x0c,0x0d,0x0e,0x0f,
      0x10,0x11,0x12,0x13, 0x14,0x15,0x16,0x17, 0x18,0x19,0x1a,0x1b, 0x1c,0x1d,0x1e,0x1f,
      0xff,0xff,0xff,0xff, 0x05,0x1a,0x5f,0x13, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0xff,0xff,0xff,0xff, 0xff,0xff,0x01,0xff, 0x66,0x25,0x99,0xcd,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0x05,0x1a,0x5f,0x13, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0xff,0xff,0xff,0xff, 0xff,0xff,0x01,0xff, 0x66,0x25,0x99,0xcd,
      0xff,0xff,0xff,0xff, 0x05,0x1a,0x5f,0x13, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0xff,0xff,0xff,0xff, 0xff,0xff,0x01,0xff, 0x66,0x25,0x99,0xcd,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0x05,0x1a,0x5f,0x13, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0xff,0xff,0xff,0xff, 0xff,0xff,0xff,0xff, 0xff,0xff,0x01,0xff, 0x66,0x25,0x99,0xcd,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
      0x00,0x71,0x00,0x03, 0x00,0x03,0x00,0x03, 0x00,0x03,0x00,0x03, 0x00,0x03,0x00,0x03
   };

   int i,j;

   memset(srm.sram, 0, sizeof(srm.sram));
   memset(srm.eeprom, 0, sizeof(srm.eeprom));
   memset(srm.eeprom2, 0, sizeof(srm.eeprom2));
   memset(srm.flashram, 0xFF, sizeof(srm.flashram));

   for (i=0; i<4; i++) {
      for (j=0; j<0x8000; j+=2) {
         srm.mempack[i][j] = 0;
         srm.mempack[i][j+1] = 0x03;
      }
      memcpy(srm.mempack[i], init, 272);
   }
}

int main(int argc, char *argv[])
{
	FILE *fp;
	int i;
	int inputs = 0;
	void (*mem_func)(const char *filename, void *dest, size_t size) = read_mem;

	if (argc < 4) {
Usage:
		printf("usage: %s output.srm [-e file.eep] [-m file.mpk] [-s file.sra] [-f file.fla]\n", argv[0]);
		exit(EXIT_FAILURE);
	}

	format_srm();

	for (i = 2; i < argc; ++i) {
		if (!strcmp(argv[i], "-h"))
			goto Usage;

		if (!strcmp(argv[i], "-x")) {
			mem_func = write_mem;
			fp = fopen(argv[1], "rb");
			fread(&srm, sizeof(srm), 1, fp);
			fclose(fp);
		}

		if (!strcmp(argv[i], "-e")) {
			if (i + 1 == argc)
				die("missing filename after -e argument");
			i++;
			mem_func(argv[i], srm.eeprom, sizeof(srm.eeprom));
			inputs++;
		}
		if (!strcmp(argv[i], "-m")) {
			if (i + 1 == argc)
				die("missing filename after -m argument");
			i++;
			mem_func(argv[i], srm.mempack, sizeof(srm.mempack));
			inputs++;
		}
		if (!strcmp(argv[i], "-s")) {
			if (i + 1 == argc)
				die("missing filename after -s argument");
			i++;
			mem_func(argv[i], srm.sram, sizeof(srm.sram));
			inputs++;
		}
		if (!strcmp(argv[i], "-f")) {
			if (i + 1 == argc)
				die("missing filename after -f argument");
			i++;
			mem_func(argv[i], srm.flashram, sizeof(srm.flashram));
			inputs++;
		}
	}

	if (!inputs)
		die("no input file.");

	if (mem_func != read_mem)
		goto quit_program;

	fp = fopen(argv[1], "wb");

	if (!fp) {
		perror(argv[1]);
		exit(EXIT_FAILURE);
	}

	fwrite(srm.eeprom, sizeof(srm.eeprom), 1, fp);
	fwrite(srm.mempack, sizeof(srm.mempack), 1, fp);
	fwrite(srm.sram, sizeof(srm.sram), 1, fp);
	fwrite(srm.flashram, sizeof(srm.flashram), 1, fp);
	fwrite(srm.eeprom2, sizeof(srm.eeprom2), 1, fp);
	fclose(fp);

quit_program:
	return EXIT_SUCCESS;
}

